<div class="users-page">

  <!-- Header card -->
  <div class="card users-header-card mb-3">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div>
        <h2 class="h5 mb-1">
          {{ loc.t('Users.HeaderTitle') }}
        </h2>
        <p class="text-muted small mb-0">
          {{ loc.t('Users.HeaderSubtitle') }}
        </p>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-2">

        <!-- Search -->
        <input
          class="form-control form-control-sm"
          style="min-width: 220px"
          [placeholder]="loc.t('Users.SearchPlaceholder')"
          [(ngModel)]="searchTerm"
          (input)="reload()"
        />

        <!-- Role Filter -->
        <select
          class="form-select form-select-sm"
          style="min-width: 160px"
          [(ngModel)]="roleFilter"
          (change)="reload()"
        >
          <option value="All">
            {{ loc.t('Users.Filter.AllRoles') }}
          </option>
          <option value="Admin">
            {{ loc.t('Users.Filter.Admin') }}
          </option>
          <option value="User">
            {{ loc.t('Users.Filter.User') }}
          </option>
          <option value="ReadOnlyUser">
            {{ loc.t('Users.Filter.ReadOnlyUser') }}
          </option>
        </select>

        <!-- Create -->
        <button
          *ngIf="isAdmin"
          class="btn btn-sm btn-primary"
          [routerLink]="['/users/new']">
          {{ loc.t('Users.Button.NewUser') }}
        </button>
      </div>
    </div>
  </div>

  <!-- Main card -->
  <div class="card users-card">
    <div class="card-body">

      <!-- Error -->
      <div *ngIf="errorMessage" class="alert alert-danger py-2 px-3 mb-2">
        {{ errorMessage }}
      </div>

      <!-- Top info row: total + page size -->
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
        <div class="text-muted small">
          {{ loc.t('Users.Label.TotalUsers') }} {{ totalItems }}
        </div>

        <div class="d-flex align-items-center gap-2">
          <label class="mb-0 small">
            {{ loc.t('Users.Label.PageSize') }}
          </label>
          <select
            class="form-select form-select-sm"
            style="width: 80px"
            [(ngModel)]="pageSize"
            (change)="reload()"
          >
            <option [ngValue]="5">5</option>
            <option [ngValue]="10">10</option>
            <option [ngValue]="25">25</option>
            <option [ngValue]="50">50</option>
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle mb-0 users-table">

          <thead class="table-light">
            <tr>
              <th
                scope="col"
                class="sortable text-nowrap"
                style="width: 24%;"
                (click)="sort('Username')">
                {{ loc.t('Users.Table.Username') }}
                <i class="ms-1" [ngClass]="sortIcon('Username')"></i>
              </th>

              <th
                scope="col"
                class="sortable text-nowrap"
                style="width: 30%;"
                (click)="sort('Email')">
                {{ loc.t('Users.Table.Email') }}
                <i class="ms-1" [ngClass]="sortIcon('Email')"></i>
              </th>

              <th
                scope="col"
                class="sortable text-nowrap"
                style="width: 18%;"
                (click)="sort('Role')">
                {{ loc.t('Users.Table.Role') }}
                <i class="ms-1" [ngClass]="sortIcon('Role')"></i>
              </th>

              <th
                scope="col"
                class="sortable text-nowrap"
                style="width: 14%;"
                (click)="sort('CreatedAt')">
                {{ loc.t('Users.Table.Created') }}
                <i class="ms-1" [ngClass]="sortIcon('CreatedAt')"></i>
              </th>

              <th
                *ngIf="isAdmin"
                scope="col"
                class="text-end text-nowrap"
                style="width: 14%;">
                {{ loc.t('Users.Table.Actions') }}
              </th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let u of users">
              <!-- Username + avatar -->
              <td>
                <div class="d-flex align-items-center">
                  <div class="user-avatar me-2">
                    {{ (u.username || '?') | slice:0:1 | uppercase }}
                  </div>
                  <div class="text-truncate">
                    <div class="fw-semibold">{{ u.username }}</div>
                  </div>
                </div>
              </td>

              <!-- Email -->
              <td class="text-truncate">
                <span class="text-muted small">{{ u.email }}</span>
              </td>

              <!-- Role -->
              <td>
                {{ getRoleName(u.role) }}
              </td>

              <!-- Created -->
              <td class="text-nowrap">
                {{ u.createdAt | date:'shortDate' }}
              </td>

              <!-- Actions -->
              <td *ngIf="isAdmin" class="text-end text-nowrap">
                <button
                  class="btn btn-outline-primary btn-sm me-1"
                  [routerLink]="['/users', u.id, 'edit']">
                  {{ loc.t('Users.Button.Edit') }}
                </button>

                <button
                  class="btn btn-outline-danger btn-sm"
                  (click)="deleteUser(u)">
                  {{ loc.t('Users.Button.Delete') }}
                </button>
              </td>
            </tr>

            <tr *ngIf="users.length === 0">
              <td [attr.colspan]="isAdmin ? 5 : 4"
                  class="text-center text-muted py-3">
                {{ loc.t('Users.Table.NoUsersFound') }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-2">
        <div class="text-muted small">
          {{ loc.t('Users.Pagination.PageLabel') }} {{ page }} / {{ totalPages }}
        </div>

        <div>
          <button
            class="btn btn-sm btn-secondary me-1"
            (click)="changePage(page - 1)"
            [disabled]="page === 1">
            {{ loc.t('Users.Pagination.Prev') }}
          </button>

          <button
            class="btn btn-sm btn-secondary"
            (click)="changePage(page + 1)"
            [disabled]="page === totalPages || totalPages === 0">
            {{ loc.t('Users.Pagination.Next') }}
          </button>
        </div>
      </div>

    </div>
  </div>
</div>
